#
# mouse:~ppr/src/docs/refman/lprsrv.8.pod
# Copyright 1995--2005, Trinity College Computing Center.
# Written by David Chappell.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
# 
# * Redistributions of source code must retain the above copyright notice,
# this list of conditions and the following disclaimer.
# 
# * Redistributions in binary form must reproduce the above copyright
# notice, this list of conditions and the following disclaimer in the
# documentation and/or other materials provided with the distribution.
# 
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE 
# LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR 
# CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF 
# SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS 
# INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN 
# CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) 
# ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE 
# POSSIBILITY OF SUCH DAMAGE.
#
# Last modified 19 August 2005.
#

=head1 NAME

lprsrv - PPR RFC 1179 (lpr/lpd) server

lprsrv.conf - Access control file

lprsrv-test - Access control test program

=head1 SYNOPSIS

B<lprsrv> I<options>

B<lprsrv-test> I<hostname> [I<username>] ...


=head1 DESCRIPTION

The B<--help> option prints a brief description of the options.
The B<--version> option prints the PPR version information.

B<lprsrv> is an RFC-1179 (Berkeley lpr/lpd) compatible print server.  It
will accept print jobs over the network and hand them to the Uprint library
for processing.  By means of the Uprint library, B<lprsrv> can deliver jobs
to PPR, as well as the BSD and System V spoolers (if present).  It can also
handle requests to list print queues and to delete jobs.

PPR version 1.32 introduced a heavily reworked B<lprsrv>.  Most of the
command line options were changed and the access control scheme was
radically altered.  The pre-1.32 B<lprsrv> is preserved as B<olprsrv>.
It will be removed completely at some point in the future.

The Uprint configuration file F</etc/ppr/uprint.conf> must be correct for
B<lprsrv> to work.  See L<UPRINT.1> for details.


=head2 Disabling Other RFC 1179 Servers

If you want to run B<lprsrv> on the standard port (and you almost certainly do),
you must disable any RFC 1179 server already running on that port.  This
section contains instructions for disabling various RFC 1179 servers. 
If your system's print server isn't covered in this section and you figure
out how to disable it, please send the necessary instructions to
ppr-bugs@trincoll.edu.

=head3 Berkely LPD

If you are using B<lpd> from Berkely (which is popular on Linux),
you must either run B<lprsrv> on a port other than 515, or you must arrange
for B<inetd> to be started before B<lpd>.  If B<inetd> is started before B<lpd>,
B<lpd> will be unable to bind to port 515 but will still work in other respects
and B<lprsrv> will pass remote jobs to B<lpr>.  (Unfortunately, some versions
of B<lpd> will die when they fail to bind to the port.  Can anyone give
better advice than this?)

=head3 LPR-NG

If you are using LPR-NG, you must add a line such as this to F</etc/lpd.conf>:

 lpd_port=1501

You can choose any unused port that you wish.  If you wish you can also restrict
access to the loopback device:

 lpd_port=127.0.0.1%1501

You should then restart lpd.

=head3 IRIX

If you are using IRIX 6.3, you should edit F</etc/init.d/lp> and find the place
where F</usr/lib/lpsched> is started.  Add the option "-nobsd" to the line.
That will make sure LP doesn't grab the port at the next reboot.  So that you
don't have to reboot after making the change, run these commands:

 # /usr/lib/lpshut
 # /usr/lib/lpsched -nobsd

=head3 SunOS 5.6 (Solaris 2.6)

If you are using SunOS 5.6 (Solaris 2.6) then you need only edit /etc/inetd.conf
and remove the line which reads:

    printer stream tcp nowait root /usr/lib/print/in.lpd in.lpd

Before this change will take effect, it is necessary to tell B<inetd> to reload
F<inetd.conf> by sending it the HUP signal.  If B<inetd> has the process id 123,
then the command for reloading F<inetd.conf> is:

    kill -HUP 123

or, if your B<kill> command doesn't support the modern syntax:

    kill -1 123


=head2 Setup With Inetd

If Inetd was installed on your system when you ran PPR's B<fixup> program
during PPR installation, it will have added the necessary line to
F</etc/services>.  (Remember, you ran /usr/lib/ppr/fixup/fixup as root right
after you ran B<make install>.) The B<fixup> program will also have put an
entry in F</etc/inetd.conf> but left it commented out.  In order to enable
B<lprsrv>, go through this section and make sure the required lines are
present and remove the comment character from in front of the line in
F</etc/inetd.conf>.

First, make sure a line like this is in F</etc/services>:

    printer		515/tcp		spooler

Then look in F</etc/inetd.conf>.  For basic versions of B<inetd>, such as
those distributed with Solaris, the line should read something like:

    printer stream tcp nowait ppr /usr/lib/ppr/lprsrv lprsrv

If Tcpwrappers was installed on your system when you installed PPR, it will
read:

    printer stream tcp nowait ppr /usr/local/sbin/tcpd /usr/lib/ppr/lprsrv

On Linux systems with TCP wrappers it will read something like:

    printer stream tcp nowait.400 ppr /usr/sbin/tcpd /usr/lib/ppr/lib/lprsrv

If the line is already present, make sure there is no "#" in front of it. 

The Linux version of Inetd allows us to specify how how many requests per
minute the server should be allowed to receive.  In the Linux
F</etc/inetd.conf> example above, the "400" specifies that the B<lprsrv>
should be allowed to handle up to 400 connections per minute.  If more than
400 requests are received during one minute, then B<inetd> will disable
B<lprsrv> for a little while.

Other versions of Inetd may not have any provision for changing the maximum
allowed number of connections.  Often they will limit all servers to 60
connections per minute.  If this is the case with you, you may want to run
B<lprsrv> in standalone mode.

Before your changes to F<inetd.conf> will take effect, B<inetd> must be
instructed to reload F<inetd.conf> by sending it the HUP signal.  If
B<inetd> has the process id 123, then the command for reloading
F<inetd.conf> is:

    kill -HUP 123

or, if your B<kill> command doesn't support the modern syntax:

    kill -1 123


=head2 Setup With Xinetd

A comparatively new alternative to Inetd is Xinetd.  It is designed to be
more flexible and to better manage the connection load.  Xinetd is used
instead of Inetd in some Linux distributions such as Mandrake.  You can
download the Xinetd source code from http://www.xinetd.org/.

Xinetd uses a configuration file format that is different from that of
Inetd.  Generally, the configuration file is F</etc/xinetd.conf> which
contains an instruction to include configuration file fragments stored
in F</etc/xinetd.d/>.  This setup makes it easy for package installers to
add and remove Xinetd configuration information from the system.  All they
have to do is add files to F</etc/xinetd.d> when installing the package and
delete them when removing the package.

If PPR's B<fixup> finds Xinetd installed on your system, it will use it
instead of Inetd.  It will create a file called F</etc/xinetd.d/ppr> which
will read in part:

    # RFC 1179 (LPR/LPD) server
    service printer
    {
        socket_type     = stream
        wait            = no
        user            = ppr
        server          = /usr/lib/ppr/lprsrv
        cps             = 400 30
        instances       = 50
        disabled        = yes
    }

Notice the line that says "disabled = yes".  You must change this to
"disabled = no" in order to enable B<lprsrv>.

After you make a change to Xinetd's configuration, you must send it the USR2
signal.  For example, if Xinetd's process id is 123:

    kill -USR2 123


=head2 Standalone Server Operation

Standalone Operation (that is, without B<inetd>) is controled by this option:

=over 4


=item B<-s> I<port>

=item B<--standalone-port> I<port>

=back

If this switch is used, in either form, B<lprsrv> will run as a daemon.  You
should use this option if for some reason you can't depend on B<inetd>.
The argument is the number or name of the port that B<lprsrv> should listen
on.  The most common value is "printer" or its numberic equivelent "515".

For you convienance, the PPR rc script (which gets installed as
F</etc/init.d/ppr> or F</etc/rc.d/init.d/ppr> or something like that) has a
commented out line to start B<lprsrv> in standalone mode.


=head2 Queue Listing Options

When a client requests a queue listing for a PPR queue, B<lprsrv> will
return the output of B<ppop lpq> for the short format and B<ppop list> for
the long format.  The B<ppop lpq> output is designed to look similiar to the
output of BSD B<lpq>.

If the B<-A> switch is used, B<lprsrv> will pass the switch and its argument
on to B<ppop>.  The argument is an integer which indicates an age in
seconds.  Arrested jobs older than the specified age will not be shown in
queue listings.

When a client requests a queue listing for an LPR/LPD queue, B<lprsrv>
simply executes B<lpq> and returns the output.

When a client requests a queue listing for a System V B<lp> queue, B<lprsrv>
runs B<lpstat>.  Some B<lpq> options are not supported for B<lp> queues.


=head2 Access Control

Access to queues through B<lprsrv> is controled by the file
F</etc/ppr/lprsrv.conf>.  The only documentation currently available is in
F</etc/ppr/lprsrv.conf.sample>.

If you use an unmodified F<lprsrv.conf.sample> for F<lprsrv.conf>, then
tranditional BSD-style access control will be in effect.  Under this style
of access control, any computer listed in F</etc/hosts.equiv> or
F</etc/hosts.lpd> will be allowed to submit jobs.  The names listed in these
files should be fully qualified names.

Since B<lprsrv> uses its own code, it may not support all of the access
control syntax described in L<hosts.equiv>.  In particular, "+" and "-" are
not supported.  Domain wildcards such as ".trincoll.edu" are supported.  NIS
netgroup support is available on some systems.

If you would like to add support for additional access control syntax in
F</etc/hosts.equiv> and F</etc/hosts.lpd>, you should modify the function
authorized_file_check() in lprsrv/lprsrv_conf.c.  If you make improvements,
please consider contributing them to the PPR project.


=head2 Access Control Testing

The program B<lprsrv-test> can be used to test the rules in F</etc/ppr/lprsrv.conf>,
F</etc/hosts.equiv>, and F</etc/hosts.lpd>.

You can use it to find out what sort of access certain users on a certain
host will have.  When you run it the first parameter should be a
hostname.  The second and subsequent parameters should be usernames.

Since several sections of F</etc/ppr/lprsrv.conf> may be combined to
determine the access settings for a certain host, it can be difficult to
determine exactly what access a particular host has.  B<lprsrv-test> solves
this by printing a merged record in F</etc/ppr/lprsrv.conf> format which
shows the final settings which apply to the host you named on the command
line.

For each remote user you name on the command line, B<lprsrv-test> will print
the name of the local user which will be used to execute spooler commands on
the remote user's behalf.  The local user used may be different for each
spooler.


=head2 Other Options

=over 4

=item B<-A> I<seconds>

=item B<--arrest-interest-interval> I<seconds>

Whenever B<lprsrv> lists a PPR queue, the argument to either of these
switches is passed to the B<ppop> command as an argument for its B<-A> switch.

=back


=head2 Support for DEC RFC-1179 Extensions

The version of B<lpr> supplied with DEC OSF/1 has many more options than the
BSD version.  Using these extra options results in extra lines in the queue
file which B<lpr> sends to B<lprsrv>.  These extensions are supported by
B<lprsrv> whenever possible.


=head2 Support for Solaris RFC-1179 Extensions

The print spooler in Solaris 2.6 (SunOS 5.6) is derived from the System V
LP spooler.  When it sends jobs using the RFC-1179 protocol it include extra
control file lines which represent System V B<lp> options.  These
extensions are supported by B<lprsrv> whenever possible.


=head2 Using Switchsets with B<lprsrv>

The B<lprsrv> configuration file does not provided any way for setting
options for individual queues.  It is suggested that you use the B<ppad switchset>,
B<ppad group switchset> and B<ppad alias switchset> commands do do this.  See
the B<ppad switchset> description for examples.

Be aware that B<lprsrv> will sometimes override switchset options.  It will always
override an B<-m> option (which shouldn't be in a switchset anyway).  It will also
override duplex, paper source, and other options if conflicting instructions
are conveyed by means of Solaris or DEC extensions to the RFC-1179 protocol.


=head2 Banner Pages

The RFC 1179 protocol provides a way for a client to ask to have banner pages
suppressed.  (The BSD B<lpr -h> option uses this feature.)  If B<lprsrv>
receives a job that requests suppression of the banner page, it will attempt
to do so.  However, suppressing the banner page may not be allowed.  In that
case, the spooler to which B<lprsrv> submits the job will likely print a banner
page anyway.

In the case of a PPR printer, if the B<ppad flags> command has been used to
set the printer's banner option to B<always>, then it will not be possible for
an RFC 1179 client to suppress the banner page.

In the case of a System V B<lp> queue, an RFC 1179 client will probably not
be able to suppress the banner page unless the B<lpadmin -o> option has
been used to set a list of printer options which includes "nobanner".


=head2 Client Configuration

This section describes the commands needed to set up various print spoolers
as clients of B<lprsrv>.  If you have information to add to this section,
please send it to ppr-bugs@trincoll.edu.

=head3 BSD lpr

Add an entry similar to the following to F</etc/printcap>.

    myprn|My Printer:\
	:rp=somehost.mycoll.edu:rm=myprn:\
	:sd=/var/spool/lpd/myprn:\
	:mx#0:

Then create the local spool directory.

    mkdir /var/spool/lpd/myprn

=head1 SEE ALSO

See L<UPRINT.1> and the comments in F</etc/ppr/lprsrv.conf>.

=head1 HISTORY

PPR was written at Trinity College during 1993--2004.

=head1 AUTHORS

David Chappell, Trinity College Computing Center, Hartford, Connecticut.

=cut
