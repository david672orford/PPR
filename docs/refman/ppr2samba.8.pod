#
# mouse:~ppr/src/docs/refman/ppr2samba.8.pod
# Copyright 1995--2005, Trinity College Computing Center.
# Written by David Chappell.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
#
# * Redistributions of source code must retain the above copyright notice,
# this list of conditions and the following disclaimer.
# 
# * Redistributions in binary form must reproduce the above copyright
# notice, this list of conditions and the following disclaimer in the
# documentation and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE 
# LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR 
# CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF 
# SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS 
# INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN 
# CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) 
# ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE 
# POSSIBILITY OF SUCH DAMAGE.
#
# Last modified 16 June 2005.
#

=head1 NAME

ppr2samba - Generates Samba configuration files from PPR configuration files

ppd2windrv - Converts PPD files and modifies Samba 2.2.x Configuration

=head1 SYNOPSIS

B<ppr2samba> [I<--nocreate>] [I<--debug>] [I<--version>] [I<--help>]

B<ppd2windrv>

=head1 DESCRIPTION

[This manpage is somewhat out of date.  An attempt has been made to correct
some of the more glaring problems, but it needs a thorough going over.]

These program are designed to make it easier to use PPR with Samba.  Samba
is an open source file and print server for SMB clients such as Microsoft
Windows 95, 98,  NT, etc.  For information on Samba refer to:

	http://www.samba.org/

The program B<ppr2samba> is used to export PPR's list of printers and groups
to a file which Samba can use the share them.  This file is called
B</etc/ppr/smb-include.conf>.

The program B<ppd2win95drv> can be used to convert PPR's collection of PPD
files to the correct format for Microsoft Windows.  Together with Samba 2.2.x
it allows not only Windows 95 clients, but Windows NT (including 2000 and XP)
clients to automatically download printer drivers.  The converted files are
stored in various subdirectories of F</var/spool/ppr/drivers>.  Since
B<ppd2win95drv> is a Perl script, you must have Perl 5 installed to use it.

If you add or remove printers from PPR, change their PPD files, or change
their descriptive comment strings, it is necessary to rerun B<ppr2samba>
so that Samba will perceive the change.

If you add, remove, replace, or modify any of the files listed in the B<[PPDs]>
section of F</etc/ppr/ppr.conf> or add or remove any of the Microsoft Windows
PostScript driver files in F</var/spool/ppr/drivers/>, or set a printer to use
a PPD file which is not in one of the directories listed in the B<[PPDs]>
section of F<ppr.conf>, you must rerun B<ppd2windrv> to reconfigure the
MS-Windows drivers.

=head2 Versions of Samba

It is recomended that you use that you use Samba 1.9.18 or later.  If you use a
version of Samba earlier than that, you must move the "printing = bsd" line in
the B<[pprproto]> section into the B<[global]> section.  You will also find
that some of the other configuration lines have no effect.

For fully automatic driver installation, Samba version 2.2.x is required.

=head2 Changes to Samba's Configuration

To use PPR with Samba you must add two lines to Samba's configuration file.
Samba's configuration file is called F<smb.conf>.  If you installed Samba from
source, it is likely to be found in the directory F</usr/local/samba/lib>.
Otherwise, it is probably F</etc/smb.conf> or F</etc/samba/smb.conf>.  Here are
the lines:

 include = /usr/lib/ppr/smb-protos.conf
 include = /etc/ppr/smb-include.conf

These lines can go at the end of the file or anywhere between sections but not
before the B<[global]> section.  The first line includes a file defines some
prototype shares which the actual print queue shares use as a source for
default values.  These prototype shares are B<[pprproto]>, and
B<[pprproto_pprpopup]>.  It also defines two disk shares which PPR uses.

The second line includes the file F<smb-include.conf> which is generated by
B<ppr2samba>.

Once you have added these lines you should run B<ppr2samba> to create the
initial F<smb-include.conf>.

You should add the name of Samba's guest user to the file
F</etc/ppr/acl/pprprox.allow>.  (The name of the user Samba uses for
guest logins is set in F<smb.conf>.  The default is generally "nobody".)
If you don't do this, jobs submitted
by guest users will appear in the MS-Windows print manager under the
name of the Samba guest user and Print Manager will grey out the
B<Document/Delete Document> menu item.

In versions of Samba at least as late as 2.0.x you must also
copy the "printer driver file =" line from the B<[pprprotos]> section
of F<smb-protos.conf> to the B<[global]> section of F<smb.conf>.  Hopefully
we can get a future version of Samba patched so that it is adaquate
to have this line in F<smb-protos.conf> with the others.

=head2 Contents of smb-protos.conf

When PPR is installed, it installs the lastest version of F<smb-protos.conf>
as F<smb-protos.conf.sample>.  If you don't have a F<smb-protos.conf> then
the sample file is copied to the real one when you run fixup.  When you upgrade
PPR you should compare the new sample file to the one you are using and
incorporate any needed changes.

The B<[pprproto]> section defines commands to submit jobs, delete jobs, list
the queue, and so forth.  When B<ppr2samba> generates the F<smb-include.conf>
file it will place a "copy =" line in each section it generates.  By default
these lines will read "copy = pprproto", so the B<[pprproto]> section serves
to set default values for PPR shares.

The option "B<-X %m@samba>" in the "B<print command =>" and "B<lprm command =>"
lines make sure that a user can only delete his own jobs.

The option "B<-f %m>" in the print command causes the name of the sending machine to appear
as the user on banner pages and in queue listings.  This option will be ignored
unless the user name which Samba uses to run B<ppr> under is listed in
F</etc/ppr/acl/pprprox.allow>.  That is why it is recomended that you put
the name of the Samba guest user in F<pprprox.allow>.  That way, guest users
can identify themselves for job tracking purposes, but other users will not
be able to override their identification.

The options "B<-e responder -m samba -r %m>" cause error messages to be sent back to the
client through the use of the responder B<samba>.  The responder B<samba> uses
Samba's B<smbclient> to send a message to the clients messenger service (winpopup
on Windows 95).

The "B<-U>" option causes the temporary file created by Samba to be deleted
after B<ppr> has copied it into the queue.

The option "B<-C ''>" prevents the job title from defaulting to the file name
since the name of the temporary file is not generally meaningful.

The print command is put into the background because it can take a long time
to run if certain filters are invoked.

The section B<[pprproto_pprpopup]> is an alternative prototype for PPR shares.
If jobs are submitted to a share which uses this prototype, then the wrapper
script B</usr/lib/ppr/samba_submitter> will be used instead of invoking
B<ppr> directly.  Before using B<ppr> to submit the job, this wrapper script
will attempt to contact a program called B<pprpopup.tcl> which is hopefully
running on the client.  The program B<pprpopup.tcl> is a Tcl/Tk script for
use on computers running Windows 95 or NT in public computer rooms.  It can
ask users to enter their names and it can receive messages which inform users
about what happened to their jobs.

If B<pprpopup.tcl> is running on the client, then it will pop up a
window which asks the user for his name.  The wrapper script will receive
the response and use it as the argument for the B<-f> switch when it invokes
B<ppr>.  It will also use the B<-m> switch to select the B<pprpopup> responder.
If B<pprpopup.tcl> is not found to be running on the client, then printing
proceeds normally and the B<samba> responder is selected.

To set a printer or group up to use B<pprpopup.tcl>, you must select the
prototype B<[pprproto_pprpopup]> instead of B<[pprproto]>.  To do this, add
this line to the printer or group configuration file:

 ppr2samba-prototype: pprproto_pprpopup

You must rerun B<ppr2samba> for the change to take effect.

The share B<[pprwin95]> contains driver files for downloading by
Microsoft Windows 95 computers.

The share B<[pprclipr]> is used by the B<audio> responder and B<audio>
commentator when sending a sound file to B<pprpopup.tcl> on a computer
running Microsoft Windows 95.

=head2 What ppr2samba Does

This program B<ppr2samba> reads the PPR printer and group configuration
files and generates the file F</etc/ppr/smb-include.conf>.  The file will
contain one Samba printer share definition for each PPR printer or group.
(See below for how to exclude printers or groups.)

Since it can only perform one function, and that non-disruptive one, any user
may run B<ppr2samba>.

Versions of B<ppr2samba> before 1.40 also generated a file called
F</etc/ppr/printcap>.  This was for compatibility with an older and
inferior scheme for using Samba and PPR together.

=head2 Special Configuration Lines

When B<ppr2samba> is reading printer and group configuration files it
recognizes several special configuration lines which only it pays
attention to.

One such line is "C<ppr2samba:>".  This takes a numberic argument.  If the
argument is non-zero, the printer or group is included in the files
generated by B<ppr2samba>, if it is zero it is ommited.  If no such line is
present, then the printer or group is included.  For example, to exclude
a printer from sharing by Samba, we add this line to its configuration file:

 ppr2samba: 0

Another such line is "C<ppr2samba-prototype:>".  This line takes a string
argument.  This argument is the name of another Samba share that should be
used as a prototype for this printer share.  By default this is "pprproto",
a prototype share defined in F<smb-protos.conf>.

To make a printer share use the B<[pprproto_pprpopup]> prototype so that
the B<pprpopup.tcl> program running on the client will be contacted to ask
the user for his name, put this line in the printer or group configuration file:

 ppr2samba-prototype: pprproto_pprpopup

The "C<ppr2samba-prototype:>" line was added in PPR version 1.41.  In
previous versions, the only way to specify the prototype was as a second
argument to the "C<ppr2samba:>" line, like this:

 ppr2samba: 1 pprproto_pprpopup

This obsolete format is still supported for compatibility.

Another such line is "C<ppr2samba-drivername:>" which can be used to override
the value B<ppr2samba> would select for the "printer driver =" line in
F<smb-include.conf>.  For example, to cause clients to use the PPD file
for the imaginary printer called "PPR Generic", put this line in a printer
or group configuration file:

 ppr2samba-drivername: PPR Generic

(Note that the printer PPR Generic is imaginary only in the sense that no
hardware with that name actually exists.  However, a PPD file describing this
hypothetical printer does exist.  This PPD file can be used to configure an
MS-Windows or Macintosh print driver so that it can invoke certain special
features of the PPR feature such as n-up printing.)

Prior to PPR version 1.40, B<ppr2samba> looked for a "C<ms-driver-name:>" line.
The name of this line was changed to "C<ppr2samba-drivername:>" in PPR
version 1.40.  If any of the old lines are found, B<ppr2samba> will print
warnings but will otherwise ignore them.

People who want to share many print queues might also want to know about the
"ppr2samba-vserver:" line.  This takes a numberic argument in the range
1 through 10.  If this line is present in a printer's or a group's
configuration file, then in addition to writing a section in F<smb-include.conf>,
B<ppr2samba> will write a section in one of ten files with names in the
form F<smb-include-N.conf>.  This will allow you to split your Samba print
server up into a number of `virtual servers'.  Some people want to do this
because under some circumstances there are limits on the size of a single
server's browse list.  [Unfortunately, the details on how to do this are
currently missing from this document.  If you are one of the people who
requested this feature, please write to <ppr-bugs@mail.trincoll.edu> with
a description of how to set up F<smb.conf> for this mode of operation.]

=head2 Setting Configuration Lines

If you do not wish to edit the queue's configuration file directly, you can use
B<ppad>.  For example, to set the "ppr2samba-drivername:" line for the printer
"myprn":

	$ ppad addon ppr2samba-drivername "PPR Generic"

If you later want to remove the option, set it without supplying a value:

	$ ppad addon ppr2samba-drivername

See the B<ppad> man page for general descriptions of the B<ppad addon>, B<ppad group addon>
and B<ppad alias addon> commands.

=head2 Command Line Options for B<ppr2samba>

The B<ppr2samba> command has an option called B<--nocreate>.  When this option
is used it will do nothing if B<smb-include.conf> does already exist.  This
option is used by the PPR WWW administration tools to skip the update of
B<smb-include.conf> if the Samba tie-in hasn't been set up.

The B<--version> option prints the PPR version number.

The B<--debug> option turns on messages which describe what B<ppr2samba> is doing.

The B<--help> option prints a brief description of the command line options
that B<ppr2samba> accepts.

=head2 What ppd2win95drv does.

The program B<ppd2win95drv> is a Perl script which prepares the directory
F</var/spool/ppr/drivers/WINPPD/> and F</var/spool/ppr/drivers/WIN40/> as a
directories from which to dispense printer drivers for Microsoft Windows 95.

Setting up this feature is not simple.  The reason is that it requires files
which may not be distributed with PPR.  These files are components of the
PostScript driver that comes with Microsoft Windows 95, and the Adobe
PostScript driver versions 4.1 and 4.2x.  You must obtain the files for
the Windows 95 driver or the Adobe 4.1 driver or both.  You may also
choose to obtain the files for Adobe's 4.2x driver which works with
PostScript level 2 printers only.

The driver that comes with Windows 95 is the easiest to get.  Install the
driver for a PostScript printer on a Windows 95 computer and copy the
following files from the F<SYSTEM> directory to F</var/spool/ppr/drivers/WIN40>
on the PPR server:

	PSCRIPT.DRV
	PSCRIPT.HLP
	FONTS.MFM
	ICONLIB.DLL
	PSMON.DLL
	PSCRIPT.INI

When this is done, run B<ppd2win95drv>.  Drag-and-drop printer installation
should work now.

Unfortunately, the PostScript driver that comes with Windows 95 has some
annoying bugs.  Adobe has distributed several later versions that fixes many
of them.  Version 4.1 from Adobe works with PostScript level 1 and level 2
printers.  To obtain it, go to:

http://www.adobe.com/supportservice/custsupport/LIBRARY/pdrvwin.htm

where you will find a link to the driver.  While you are there you might as
well download the 4.2x driver too.  (Note, it appears that Adobe is no
longer distributing the version 4.1 driver.  This is a pity.  Does anyone
know of a place from which it may still be downloaded?)

Install the driver on a computer running Windows 95 and then copy these files
from the F<SYSTEM> directory to F</var/spool/ppr/drivers/WIN40> on the PPR server:

	ADOBEPS4.DRV (rename to ADBEPS41.DRV)
	ADOBEPS4.HLP
	FONTS.MFM
	ICONLIB.DLL
	PSMON.DLL

No you can rerun B<ppd2win95drv> and now when you drag-and-drop a PPR printer
share, the newer Adobe driver will be installed instead of the one that
came with Windows 95.

The 4.2x Adobe driver is newer than the one we installed above, but it won't
work with PostScript level 1 printers.  Adobe says that it is not possible
to have the 4.1 and the 4.2x drivers installed simulaineously on the same
Windows 95 computer because the drivers both have a file called F<ADOBEPS4.DRV>.
To get around this we renamed the file from the 4.1 driver in the previous step.

To install the 4.2x driver on the server, install it on a Windows 95 computer
as you did with the others.  Then copy the following files from the F<SYSTEM>
directory to F</var/spool/ppr/drivers/WIN40> on the PPR server:

	ADOBEPS4.DRV
	ADOBEPS4.HLP
	ADFONTS.MFM
	ICONLIB.DLL
	PSMON.DLL
	PSCRIPT.INI

then rerun B<ppd2win95drv>.  Once this is done, drag-and-drop installing
a printer that supports level 2 PostScript will result in the installation of
the 4.2x Adobe driver rather than the 4.1 Adobe driver or the driver that came
with Windows 95.

=head1 SEE ALSO

Samba's L<smb.conf>(5), "Installing and Using PPR", L<ppr.1>(1).

=head1 HISTORY

PPR was written at Trinity College during 1993--2004.
It was first released to the public on 26 April 1995.

=head1 AUTHORS

David Chappell, Trinity College Computing Center, Hartford, Connecticut.

=head1 BUGS

It is necessary to rerun B<ppr2samba> after adding or removing printers
and groups or changing PPD files.  This should be done automatically.

=cut
